import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import SettingsModal from '@/components/SettingsModal';

// Mock hooks
jest.mock('@/hooks/useSettings', () => ({
  useSettings: () => ({
    settings: {
      githubToken: undefined,
      theme: 'light',
      language: 'ko',
    },
    setGithubToken: jest.fn(),
    removeGithubToken: jest.fn(),
    setTheme: jest.fn(),
    setLanguage: jest.fn(),
    resetSettings: jest.fn(),
    isTokenValid: null,
    isValidating: false,
  }),
}));

jest.mock('@/hooks/useTranslation', () => ({
  useTranslation: () => ({
    t: {
      settingsModal: {
        title: 'ÏÑ§Ï†ï',
        githubToken: 'GitHub ÌÜ†ÌÅ∞',
        githubTokenDescription: 'GitHub Personal Access TokenÏùÑ ÏÑ§Ï†ïÌïòÎ©¥ API ÏÇ¨Ïö©Îüâ Ï†úÌïúÏùÑ ÎäòÎ¶¨Í≥† Îçî ÎßéÏùÄ Ï†ÄÏû•ÏÜå Ï†ïÎ≥¥Î•º Ï†úÍ≥µÎ∞õÏùÑ Ïàò ÏûàÏäµÎãàÎã§.',
        createToken: 'ÌÜ†ÌÅ∞ ÏÉùÏÑ±ÌïòÍ∏∞',
        tokenPlaceholder: 'ghp_xxxxxxxxxxxxxxxxxxxx',
        save: 'Ï†ÄÏû•',
        saving: 'Ï†ÄÏû• Ï§ë...',
        validating: 'Í≤ÄÏ¶ù Ï§ë...',
        remove: 'Ï†úÍ±∞',
        validToken: 'Ïú†Ìö®Ìïú ÌÜ†ÌÅ∞',
        invalidToken: 'Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÌÜ†ÌÅ∞',
        theme: 'ÌÖåÎßà',
        light: 'ÎùºÏù¥Ìä∏',
        dark: 'Îã§ÌÅ¨',
        language: 'Ïñ∏Ïñ¥ ÏÑ§Ï†ï',
        resetSettings: 'ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî',
        resetConfirm: 'Î™®Îì† ÏÑ§Ï†ïÏùÑ Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?',
      },
    },
  }),
}));

describe('SettingsModal', () => {
  const mockOnClose = jest.fn();
  const defaultProps = {
    isOpen: true,
    onClose: mockOnClose,
  };

  beforeEach(() => {
    mockOnClose.mockClear();
  });

  it('renders modal when isOpen is true', () => {
    render(<SettingsModal {...defaultProps} />);
    
    expect(screen.getByText('ÏÑ§Ï†ï')).toBeInTheDocument();
    expect(screen.getByText('GitHub ÌÜ†ÌÅ∞')).toBeInTheDocument();
    expect(screen.getByText('ÌÖåÎßà')).toBeInTheDocument();
    expect(screen.getByText('Ïñ∏Ïñ¥ ÏÑ§Ï†ï')).toBeInTheDocument();
  });

  it('does not render when isOpen is false', () => {
    render(<SettingsModal {...defaultProps} isOpen={false} />);
    
    expect(screen.queryByText('ÏÑ§Ï†ï')).not.toBeInTheDocument();
  });

  it('calls onClose when close button is clicked', async () => {
    const user = userEvent.setup();
    render(<SettingsModal {...defaultProps} />);
    
    const closeButton = screen.getByRole('button', { name: /close/i });
    await user.click(closeButton);
    
    expect(mockOnClose).toHaveBeenCalled();
  });

  it('renders GitHub token section', () => {
    render(<SettingsModal {...defaultProps} />);
    
    expect(screen.getByText('GitHub Personal Access TokenÏùÑ ÏÑ§Ï†ïÌïòÎ©¥')).toBeInTheDocument();
    expect(screen.getByText('ÌÜ†ÌÅ∞ ÏÉùÏÑ±ÌïòÍ∏∞')).toBeInTheDocument();
    expect(screen.getByPlaceholderText('ghp_xxxxxxxxxxxxxxxxxxxx')).toBeInTheDocument();
  });

  it('handles GitHub token input', async () => {
    const user = userEvent.setup();
    render(<SettingsModal {...defaultProps} />);
    
    const tokenInput = screen.getByPlaceholderText('ghp_xxxxxxxxxxxxxxxxxxxx');
    await user.type(tokenInput, 'ghp_test_token');
    
    expect(tokenInput).toHaveValue('ghp_test_token');
  });

  it('toggles token visibility', async () => {
    const user = userEvent.setup();
    render(<SettingsModal {...defaultProps} />);
    
    const tokenInput = screen.getByPlaceholderText('ghp_xxxxxxxxxxxxxxxxxxxx');
    const toggleButton = screen.getByRole('button', { name: /eye/i });
    
    // Initially password type
    expect(tokenInput).toHaveAttribute('type', 'password');
    
    // Click to show
    await user.click(toggleButton);
    expect(tokenInput).toHaveAttribute('type', 'text');
    
    // Click to hide
    await user.click(toggleButton);
    expect(tokenInput).toHaveAttribute('type', 'password');
  });

  it('renders theme selection buttons', () => {
    render(<SettingsModal {...defaultProps} />);
    
    expect(screen.getByText('ÎùºÏù¥Ìä∏')).toBeInTheDocument();
    expect(screen.getByText('Îã§ÌÅ¨')).toBeInTheDocument();
  });

  it('handles theme selection', async () => {
    const mockSetTheme = jest.fn();
    jest.mocked(require('@/hooks/useSettings').useSettings).mockReturnValue({
      settings: { theme: 'light', language: 'ko' },
      setTheme: mockSetTheme,
      setLanguage: jest.fn(),
      resetSettings: jest.fn(),
      isTokenValid: null,
      isValidating: false,
    });

    const user = userEvent.setup();
    render(<SettingsModal {...defaultProps} />);
    
    const darkButton = screen.getByText('Îã§ÌÅ¨');
    await user.click(darkButton);
    
    expect(mockSetTheme).toHaveBeenCalledWith('dark');
  });

  it('renders language selection', () => {
    render(<SettingsModal {...defaultProps} />);
    
    expect(screen.getByText('üá∞üá∑')).toBeInTheDocument(); // Korean flag
    expect(screen.getByText('üá∫üá∏')).toBeInTheDocument(); // US flag  
    expect(screen.getByText('üá®üá≥')).toBeInTheDocument(); // Chinese flag
    expect(screen.getByText('ÌïúÍµ≠Ïñ¥')).toBeInTheDocument();
    expect(screen.getByText('English')).toBeInTheDocument();
    expect(screen.getByText('‰∏≠Êñá')).toBeInTheDocument();
  });

  it('handles language selection', async () => {
    const mockSetLanguage = jest.fn();
    jest.mocked(require('@/hooks/useSettings').useSettings).mockReturnValue({
      settings: { theme: 'light', language: 'ko' },
      setTheme: jest.fn(),
      setLanguage: mockSetLanguage,
      resetSettings: jest.fn(),
      isTokenValid: null,
      isValidating: false,
    });

    const user = userEvent.setup();
    render(<SettingsModal {...defaultProps} />);
    
    const englishButton = screen.getByText('English');
    await user.click(englishButton);
    
    expect(mockSetLanguage).toHaveBeenCalledWith('en');
  });

  it('shows token validation status', () => {
    jest.mocked(require('@/hooks/useSettings').useSettings).mockReturnValue({
      settings: { githubToken: 'test_token' },
      isTokenValid: true,
      isValidating: false,
      setTheme: jest.fn(),
      setLanguage: jest.fn(),
      resetSettings: jest.fn(),
    });

    render(<SettingsModal {...defaultProps} />);
    
    expect(screen.getByText('Ïú†Ìö®Ìïú ÌÜ†ÌÅ∞')).toBeInTheDocument();
  });

  it('shows invalid token status', () => {
    jest.mocked(require('@/hooks/useSettings').useSettings).mockReturnValue({
      settings: { githubToken: 'invalid_token' },
      isTokenValid: false,
      isValidating: false,
      setTheme: jest.fn(),
      setLanguage: jest.fn(),
      resetSettings: jest.fn(),
    });

    render(<SettingsModal {...defaultProps} />);
    
    expect(screen.getByText('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÌÜ†ÌÅ∞')).toBeInTheDocument();
  });

  it('shows validating state', () => {
    jest.mocked(require('@/hooks/useSettings').useSettings).mockReturnValue({
      settings: {},
      isTokenValid: null,
      isValidating: true,
      setTheme: jest.fn(),
      setLanguage: jest.fn(),
      resetSettings: jest.fn(),
    });

    render(<SettingsModal {...defaultProps} />);
    
    expect(screen.getByText('Í≤ÄÏ¶ù Ï§ë...')).toBeInTheDocument();
  });

  it('shows remove button when token exists', () => {
    jest.mocked(require('@/hooks/useSettings').useSettings).mockReturnValue({
      settings: { githubToken: 'existing_token' },
      removeGithubToken: jest.fn(),
      isTokenValid: null,
      isValidating: false,
      setTheme: jest.fn(),
      setLanguage: jest.fn(),
      resetSettings: jest.fn(),
    });

    render(<SettingsModal {...defaultProps} />);
    
    expect(screen.getByText('Ï†úÍ±∞')).toBeInTheDocument();
  });

  it('handles settings reset with confirmation', async () => {
    const mockResetSettings = jest.fn();
    jest.mocked(require('@/hooks/useSettings').useSettings).mockReturnValue({
      settings: {},
      resetSettings: mockResetSettings,
      isTokenValid: null,
      isValidating: false,
      setTheme: jest.fn(),
      setLanguage: jest.fn(),
    });

    // Mock window.confirm
    window.confirm = jest.fn(() => true);

    const user = userEvent.setup();
    render(<SettingsModal {...defaultProps} />);
    
    const resetButton = screen.getByText('ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî');
    await user.click(resetButton);
    
    expect(window.confirm).toHaveBeenCalledWith('Î™®Îì† ÏÑ§Ï†ïÏùÑ Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?');
    expect(mockResetSettings).toHaveBeenCalled();
  });

  it('cancels reset when confirmation is declined', async () => {
    const mockResetSettings = jest.fn();
    jest.mocked(require('@/hooks/useSettings').useSettings).mockReturnValue({
      settings: {},
      resetSettings: mockResetSettings,
      isTokenValid: null,
      isValidating: false,
      setTheme: jest.fn(),
      setLanguage: jest.fn(),
    });

    // Mock window.confirm to return false
    window.confirm = jest.fn(() => false);

    const user = userEvent.setup();
    render(<SettingsModal {...defaultProps} />);
    
    const resetButton = screen.getByText('ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî');
    await user.click(resetButton);
    
    expect(mockResetSettings).not.toHaveBeenCalled();
  });

  it('disables save button when token is empty', () => {
    render(<SettingsModal {...defaultProps} />);
    
    const saveButton = screen.getByText('Ï†ÄÏû•');
    expect(saveButton).toBeDisabled();
  });

  it('handles modal close on backdrop click', async () => {
    const user = userEvent.setup();
    render(<SettingsModal {...defaultProps} />);
    
    const backdrop = screen.getByText('ÏÑ§Ï†ï').closest('.fixed');
    if (backdrop) {
      await user.click(backdrop);
      expect(mockOnClose).toHaveBeenCalled();
    }
  });

  it('prevents close when clicking on modal content', async () => {
    const user = userEvent.setup();
    render(<SettingsModal {...defaultProps} />);
    
    const modalContent = screen.getByText('GitHub ÌÜ†ÌÅ∞').closest('.bg-white');
    if (modalContent) {
      await user.click(modalContent);
      expect(mockOnClose).not.toHaveBeenCalled();
    }
  });

  it('supports keyboard navigation', async () => {
    const user = userEvent.setup();
    render(<SettingsModal {...defaultProps} />);
    
    // Tab should navigate through interactive elements
    await user.tab();
    expect(screen.getByPlaceholderText('ghp_xxxxxxxxxxxxxxxxxxxx')).toHaveFocus();
    
    await user.tab();
    expect(screen.getByText('Ï†ÄÏû•')).toHaveFocus();
  });

  it('renders save settings button with proper styling', () => {
    render(<SettingsModal {...defaultProps} />);
    
    expect(screen.getByText('‚ö° ÏÑ§Ï†ï Ï†ÄÏû• Î∞è Ï†ÅÏö©')).toBeInTheDocument();
    expect(screen.getByText('ÏÑ§Ï†ïÏùÑ Ï†ÄÏû•ÌïòÍ≥† ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨ Î™®Îì† Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ Ï†ÅÏö©Ìï©ÎãàÎã§.')).toBeInTheDocument();
  });

  it('handles save and refresh functionality', async () => {
    const mockReload = jest.fn();
    Object.defineProperty(window, 'location', {
      value: { reload: mockReload },
      writable: true,
    });

    // Mock localStorage
    const mockSetItem = jest.fn();
    Object.defineProperty(window, 'localStorage', {
      value: { setItem: mockSetItem },
      writable: true,
    });

    jest.mocked(require('@/hooks/useSettings').useSettings).mockReturnValue({
      settings: { githubToken: 'test_token', theme: 'dark', language: 'en' },
      isTokenValid: null,
      isValidating: false,
      setTheme: jest.fn(),
      setLanguage: jest.fn(),
      resetSettings: jest.fn(),
    });

    const user = userEvent.setup();
    render(<SettingsModal {...defaultProps} />);
    
    const saveButton = screen.getByText('‚ö° ÏÑ§Ï†ï Ï†ÄÏû• Î∞è Ï†ÅÏö©');
    await user.click(saveButton);
    
    expect(mockSetItem).toHaveBeenCalledWith('app-settings', JSON.stringify({
      githubToken: 'test_token',
      theme: 'dark',
      language: 'en'
    }));
    expect(mockReload).toHaveBeenCalled();
  });

  it('renders 12 language options in dropdown', () => {
    render(<SettingsModal {...defaultProps} />);
    
    // Check for some of the 12 languages
    expect(screen.getByText('üá∞üá∑ ÌïúÍµ≠Ïñ¥')).toBeInTheDocument();
    expect(screen.getByText('üá∫üá∏ English')).toBeInTheDocument();
    expect(screen.getByText('üá®üá≥ ‰∏≠Êñá')).toBeInTheDocument();
    expect(screen.getByText('üáØüáµ Êó•Êú¨Ë™û')).toBeInTheDocument();
    expect(screen.getByText('üá™üá∏ Espa√±ol')).toBeInTheDocument();
    expect(screen.getByText('üá´üá∑ Fran√ßais')).toBeInTheDocument();
  });

  it('shows language support notice for unsupported languages', () => {
    jest.mocked(require('@/hooks/useSettings').useSettings).mockReturnValue({
      settings: { theme: 'light', language: 'es' }, // Spanish - not fully supported
      setTheme: jest.fn(),
      setLanguage: jest.fn(),
      resetSettings: jest.fn(),
      isTokenValid: null,
      isValidating: false,
    });

    render(<SettingsModal {...defaultProps} />);
    
    expect(screen.getByText('‚ö†Ô∏è This language is not fully supported yet.')).toBeInTheDocument();
    expect(screen.getByText('Currently supported: ÌïúÍµ≠Ïñ¥, English, ‰∏≠Êñá')).toBeInTheDocument();
  });

  it('applies DOM changes immediately for theme selection', async () => {
    // Mock document.documentElement
    const mockClassList = {
      remove: jest.fn(),
      add: jest.fn(),
    };
    Object.defineProperty(document, 'documentElement', {
      value: { classList: mockClassList },
      writable: true,
    });

    const user = userEvent.setup();
    render(<SettingsModal {...defaultProps} />);
    
    const darkButton = screen.getByText('Îã§ÌÅ¨');
    await user.click(darkButton);
    
    expect(mockClassList.remove).toHaveBeenCalledWith('light');
    expect(mockClassList.add).toHaveBeenCalledWith('dark');
  });

  it('applies DOM changes immediately for language selection', async () => {
    // Mock document.documentElement
    const mockDocumentElement = { lang: '' };
    Object.defineProperty(document, 'documentElement', {
      value: mockDocumentElement,
      writable: true,
    });

    // Mock custom event dispatch
    const mockDispatchEvent = jest.fn();
    Object.defineProperty(window, 'dispatchEvent', {
      value: mockDispatchEvent,
      writable: true,
    });

    const user = userEvent.setup();
    render(<SettingsModal {...defaultProps} />);
    
    const languageSelect = screen.getByDisplayValue('üá∞üá∑ ÌïúÍµ≠Ïñ¥');
    await user.selectOptions(languageSelect, 'en');
    
    expect(mockDocumentElement.lang).toBe('en');
  });

  it('handles reset with token input clearing', async () => {
    const mockResetSettings = jest.fn();
    jest.mocked(require('@/hooks/useSettings').useSettings).mockReturnValue({
      settings: { githubToken: 'existing_token' },
      resetSettings: mockResetSettings,
      isTokenValid: null,
      isValidating: false,
      setTheme: jest.fn(),
      setLanguage: jest.fn(),
    });

    // Mock window.confirm
    window.confirm = jest.fn(() => true);

    const user = userEvent.setup();
    render(<SettingsModal {...defaultProps} />);
    
    // First add some text to token input
    const tokenInput = screen.getByPlaceholderText('ghp_xxxxxxxxxxxxxxxxxxxx');
    await user.type(tokenInput, 'new_token');
    
    const resetButton = screen.getByText('üîÑ ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî');
    await user.click(resetButton);
    
    expect(mockResetSettings).toHaveBeenCalled();
    expect(tokenInput).toHaveValue(''); // Should be cleared
  });
});